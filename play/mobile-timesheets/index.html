<!DOCTYPE html>
<html>
<head>
<title>Coincraft Timesheets</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=0">
<link rel="stylesheet" type="text/css" href="styles.css">
<link href='https://fonts.googleapis.com/css?family=Open+Sans:400,400italic,600,600italic,700,700italic&subset=latin,greek' rel='stylesheet' type='text/css'>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.13.3/react.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.13.3/JSXTransformer.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.13.0/moment.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore.js"></script>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
</head>


<script type="text/jsx">

	var ProjectItem = React.createClass({

			propTypes: {
				costCentreName: React.PropTypes.string,
				projectName: React.PropTypes.string,
				phaseName: React.PropTypes.string,
				hoursSaved: React.PropTypes.number,
				minutesSaved: React.PropTypes.number,
				id: React.PropTypes.number,
				updateHours: React.PropTypes.func,
				deleteEntry: React.PropTypes.func
			},

			getDefaultProps: function() {
				return {
					costCentreName: '',
					projectName:  '',
					phaseName:  '',
					hoursSaved: 0,
					minutesSaved: 0
				}
			},

			getInitialState: function(){
				return {
					timerSeconds: 0,
					timerSavedSeconds: 0,
					timerStart: Date.now(),
					timeEntered: this.savedTimeToString(),
					noteSaved: '',
					noteEntered: '',
					timerOn: false,
					expanded: false,
					dropDownType: 'generic'
				}
			},

			clickProjSel: function() {
			  this.setState({expanded: !this.state.expanded, dropDownType: 'generic'});
			},

			timerClick: function(e) {
			  this.setState({dropDownType: 'timer', timerStart: Date.now(), timerOn: true});
			  this.timer = setInterval(this.timerTick, 1000);
			},

			timerStartClick: function(e) {
			  this.setState({timerStart: Date.now(), timerOn: true});
			  this.timer = setInterval(this.timerTick, 1000);
			},

			timerPauseClick: function(e) {
			  this.setState({timerOn: false, timerSavedSeconds: this.state.timerSavedSeconds + this.state.timerSeconds, timerSeconds: 0});
			  clearInterval(this.timer);
			},

			timerTick: function(e) {
				this.setState({timerSeconds: Math.round((Date.now() - this.state.timerStart)/1000)});
			},

			timerCancelClick: function(e) {
			  this.setState({dropDownType: 'generic', timerSeconds: 0});
			},

			timerSaveClick: function(e) {
				hours = parseInt(this.state.timerSavedSeconds/3600);
				minutes = Math.round(this.state.timerSavedSeconds/60) - hours*60;
				totalHours = this.props.hoursSaved + hours;
				totalMinutes = this.props.minutesSaved + minutes;
			  	this.setState({dropDownType: 'generic', timerSeconds: 0, timerSavedSeconds: 0, /*hoursSaved: totalHours, minutesSaved: totalMinutes,*/ timeEntered: this.timeToString(totalHours, totalMinutes)});
				this.props.updateHours(this.props.id, totalHours, totalMinutes);
			},

			inputTimeClick: function(e) {
			  this.setState({dropDownType: 'time-input'});
			},

			inputTimeCancelClick: function(e) {
			  this.setState({dropDownType: 'generic', timeEntered: this.savedTimeToString()});
			},

			inputTimeSaveClick: function(e) {
				this.saveEnteredTime();
			  	this.setState({dropDownType: 'generic'});
			},

			inputTimeOnChange: function(e) {
			  value = e.target.value.replace(/[^0-9.:]+/g, '');
				specialChars = value.replace(/[^.:]/g,'');
				specialChars.length > 1 ? value = value.slice(0, -1) : null;
				this.setState({timeEntered: value});
			},

			noteClick: function(e) {
			  this.setState({dropDownType: 'note'});
			},

			noteCancelClick: function(e) {
			  this.setState({dropDownType: 'generic', noteEntered: this.state.noteSaved});
			},

			noteSaveClick: function(e) {
			  this.setState({dropDownType: 'generic', noteSaved: this.state.noteEntered});
			},

			noteOnChange: function(e) {
			  this.setState({noteEntered: e.target.value});
			},

			deleteClick: function(e) {
			  this.props.deleteEntry(this.props.id);
			},

			savedTimeToString: function() {
			  return this.timeToString(this.props.hoursSaved, this.props.minutesSaved);
			},

			timeToString: function(hours, minutes) {
			  return (hours.toString() + ":" + ("0" + minutes.toString()).slice(-2));
			},

			secondsToString: function(inSeconds) {
				hours = parseInt(inSeconds/3600);
				minutes = parseInt(inSeconds/60) - hours*60;
				seconds = inSeconds - minutes*60 - hours*3600;
			  	return (("0" + hours.toString()).slice(-2) + ":" + ("0" + minutes.toString()).slice(-2) + ":" + ("0" +seconds.toString()).slice(-2));
			},

			timerString: function() {
				seconds = this.state.timerSavedSeconds + this.state.timerSeconds + this.props.hoursSaved*3600 + this.props.minutesSaved*60;
				return this.secondsToString(seconds);
			},

			saveEnteredTime: function() {
				if (this.state.timeEntered.length > 0) {
				  if (this.state.timeEntered.indexOf(':') > -1) {
				  	split = this.state.timeEntered.split(':');
				  	split[0].length > 0 ? hours = parseInt(split[0]) : hours = 0;
				  	split[1].length > 0 ? minutes = parseInt(split[1]) : minutes = 0;

				  	hours = hours + parseInt(minutes/60);
				  	minutes = minutes - parseInt(minutes/60)*60;

				  } else if (this.state.timeEntered.indexOf('.') > -1) {
				  	minutes = parseFloat(this.state.timeEntered);
				  	minutes >= 1 ? hours = parseInt(this.state.timeEntered) : hours = 0; //parseInt('.5') => NaN

					minutes = Math.round((minutes-hours)*60);

				  } else {
				  	hours = 0;
				  	minutes = parseInt(this.state.timeEntered);

				  	hours = hours + parseInt(minutes/60);
				  	minutes = minutes - parseInt(minutes/60)*60;
				  }
				} else {
					hours = 0;
					minutes = 0;
				}
				this.setState({/*hoursSaved: hours, minutesSaved: minutes,*/ timeEntered: this.timeToString(hours,minutes)});
				this.props.updateHours(this.props.id, hours, minutes);
			},


			cancelClick: function(e) {
			  this.setState({dropDownType: 'generic'});
			},

			render: function(){

				var dropDown;

				switch(this.state.dropDownType) {

					case "timer":
						dropDown = <div className="project-dropdown two-btn">
										<div className="project-timer">
											{this.timerString()}
										</div>
										<div className="project-options">
											<div className="pr-opt" onClick={this.timerSaveClick}>
												<span className="pr-opt-icon notes">
													<i className="fa fa-download"> </i>
												</span>
												<span className="pr-opt-label">
													Save
												</span>
											</div>
											{this.state.timerOn ?
												<div className="pr-opt" onClick={this.timerPauseClick}>
													<span className="pr-opt-icon timer">
														<i className="fa fa-pause"> </i>
													</span>
													<span className="pr-opt-label">
														Pause
													</span>
												</div>
											: <div className="pr-opt" onClick={this.timerStartClick}>
													<span className="pr-opt-icon timer">
														<i className="fa fa-play"> </i>
													</span>
													<span className="pr-opt-label">
														Start
													</span>
												</div>
											}
											<div className="pr-opt" onClick={this.timerCancelClick}>
												<span className="pr-opt-icon delete">
													<i className="fa fa-times"> </i>
												</span>
												<span className="pr-opt-label">
													Cancel
												</span>
											</div>
										</div>
									</div>;
						break;

					case "time-input":
						dropDown = <div className="project-dropdown two-btn">
									<div className="project-input">
										<input type="text" maxLength={5} value={this.state.timeEntered} onChange={this.inputTimeOnChange}/>
									</div>
									<div className="project-options">
										<div className="pr-opt" onClick={this.inputTimeSaveClick}>
											<span className="pr-opt-icon notes">
												<i className="fa fa-download"> </i>
											</span>
											<span className="pr-opt-label">
												Save
											</span>
										</div>
										<div className="pr-opt" onClick={this.inputTimeCancelClick}>
											<span className="pr-opt-icon delete">
												<i className="fa fa-times"> </i>
											</span>
											<span className="pr-opt-label">
												Cancel
											</span>
										</div>
									</div>
								</div>;
						break;

					case "note":
						dropDown = <div className="project-dropdown two-btn">
									<div className="project-note">
										<textarea rows="3" placeholder="Text goes here..." onChange={this.noteOnChange}>{this.state.noteEntered}</textarea>
									</div>
									<div className="project-options">
										<div className="pr-opt" onClick={this.noteSaveClick}>
											<span className="pr-opt-icon notes">
												<i className="fa fa-download"> </i>
											</span>
											<span className="pr-opt-label">
												Save
											</span>
										</div>
										<div className="pr-opt" onClick={this.noteCancelClick}>
											<span className="pr-opt-icon delete">
												<i className="fa fa-times"> </i>
											</span>
											<span className="pr-opt-label">
												Cancel
											</span>
										</div>
									</div>
								</div>;
						break;

					default:
						dropDown = <div className="project-dropdown">
									<div className="project-options">
										<div className="pr-opt" onClick={this.timerClick}>
											<span className="pr-opt-icon timer">
												<i className="fa fa-play"> </i>
											</span>
											<span className="pr-opt-label">
												Start Timer
											</span>
										</div>
										<div className="pr-opt" onClick={this.inputTimeClick}>
											<span className="pr-opt-icon input">
												<i className="fa fa-clock-o"> </i>
											</span>
											<span className="pr-opt-label">
												Enter Time
											</span>
										</div>
										<div className="pr-opt" onClick={this.noteClick}>
											<span className="pr-opt-icon notes">
												<i className="fa fa-sticky-note"> </i>
											</span>
											<span className="pr-opt-label">
												Add Note
											</span>
										</div>
										<div className="pr-opt" onClick={this.deleteClick}>
											<span className="pr-opt-icon delete">
												<i className="fa fa-times"> </i>
											</span>
											<span className="pr-opt-label">
												Delete Entry
											</span>
										</div>
									</div>
								</div>;
				}


				return (

						<div className="project">
							<div className="project-sel" onClick={this.clickProjSel}>
								<div className="project-text">
									<span className="cc-name">{this.props.costCentreName}</span>
									<span className="pr-name">{this.props.projectName}</span>
									<span className="ph-name">{this.props.phaseName}</span>
								</div>
								<div className="project-time">
									{this.savedTimeToString()}
								</div>
							</div>
							{this.state.expanded ? dropDown : null}
						</div>

				);
			}
		});

		var ProjectList = React.createClass({

			propTypes: {
				projects: React.PropTypes.object,
				updateHours: React.PropTypes.func,
				deleteEntry: React.PropTypes.func
			},

			getDefaultProps: function() {
				return {
					projects: {}
				}
			},

			render: function(){

				var projectList = [];
				var projects = this.props.projects;
				var updateHours = this.props.updateHours;
				var deleteEntry = this.props.deleteEntry;

				var projectList = projects.map(function(project){
					return (
						<ProjectItem
	        		key={project.id}
	        		id={project.id}
	        		costCentreName={project.costCentreName}
	        		projectName={project.projectName}
	        		phaseName={project.phaseName}
	        		hoursSaved={project.hoursSaved}
	        		minutesSaved={project.minutesSaved}
	        		updateHours={updateHours}
	        	/>
					);
				});

				return (
						<div className="projects-list">
							{projectList}
						</div>
				);

			}
		});



		var TimeEntryPage = React.createClass({

			getInitialState: function(){
				return {
					timesheets: [
						{date: moment().startOf('day').subtract(1, 'days'),
						projects: [
							{id: 1, costCentreName: "Projects", projectName: "Walsh St", phaseName: "Concept Design", hoursSaved: 1, minutesSaved: 40},
							{id: 2, costCentreName: "Projects", projectName: "Sydeny Opera House", phaseName: "Documentation", hoursSaved: 1, minutesSaved: 20},
							{id: 3, costCentreName: "Marketing", projectName: "Photography", phaseName: "", hoursSaved: 0, minutesSaved: 30},
							{id: 4, costCentreName: "Admin", projectName: "Staff Meetings", phaseName: " ", hoursSaved: 0, minutesSaved: 0},
							{id: 5, costCentreName: "Admin", projectName: "General Admin", phaseName: " ", hoursSaved: 0, minutesSaved: 0},
							{id: 6, costCentreName: "Projects", projectName: "Falling Water", phaseName: "Design Development", hoursSaved: 0, minutesSaved: 0},
							{id: 7, costCentreName: "Projects", projectName: "Villa Savoye", phaseName: "Documentation", hoursSaved: 1, minutesSaved: 0},
							{id: 8, costCentreName: "Marketing", projectName: "Social Media", phaseName: "", hoursSaved: 2, minutesSaved: 0}
						]},
						{date: moment().startOf('day'),
						projects: [
							{id: 1, costCentreName: "Projects", projectName: "Walsh St", phaseName: "Concept Design", hoursSaved: 3, minutesSaved: 40},
							{id: 2, costCentreName: "Projects", projectName: "Sydeny Opera House", phaseName: "Documentation", hoursSaved: 2, minutesSaved: 20},
							{id: 3, costCentreName: "Marketing", projectName: "Photography", phaseName: "", hoursSaved: 0, minutesSaved: 30},
							{id: 4, costCentreName: "Admin", projectName: "Staff Meetings", phaseName: " ", hoursSaved: 1, minutesSaved: 30},
							{id: 5, costCentreName: "Admin", projectName: "General Admin", phaseName: " ", hoursSaved: 0, minutesSaved: 0},
							{id: 6, costCentreName: "Projects", projectName: "Falling Water", phaseName: "Design Development", hoursSaved: 0, minutesSaved: 0},
							{id: 7, costCentreName: "Projects", projectName: "Villa Savoye", phaseName: "Documentation", hoursSaved: 0, minutesSaved: 0},
							{id: 8, costCentreName: "Marketing", projectName: "Social Media", phaseName: "", hoursSaved: 0, minutesSaved: 0}
						]},
						{date: moment().startOf('day').add(1, 'days'),
						projects: [
							{id: 1, costCentreName: "Projects", projectName: "Walsh St", phaseName: "Concept Design", hoursSaved: 1, minutesSaved: 40},
							{id: 2, costCentreName: "Projects", projectName: "Sydeny Opera House", phaseName: "Documentation", hoursSaved: 2, minutesSaved: 20},
							{id: 3, costCentreName: "Marketing", projectName: "Photography", phaseName: "", hoursSaved: 0, minutesSaved: 30},
							{id: 4, costCentreName: "Admin", projectName: "Staff Meetings", phaseName: " ", hoursSaved: 1, minutesSaved: 0},
							{id: 5, costCentreName: "Admin", projectName: "General Admin", phaseName: " ", hoursSaved: 2, minutesSaved: 0},
							{id: 6, costCentreName: "Projects", projectName: "Falling Water", phaseName: "Design Development", hoursSaved: 0, minutesSaved: 0},
							{id: 7, costCentreName: "Projects", projectName: "Villa Savoye", phaseName: "Documentation", hoursSaved: 0, minutesSaved: 0},
							{id: 8, costCentreName: "Marketing", projectName: "Social Media", phaseName: "", hoursSaved: 1, minutesSaved: 0}
						]}
					],
				currentDate: moment().startOf('day'),
				selectedDate: moment().startOf('day'),
				currentWeek: moment().startOf('isoWeek')
				}
			},

			updateHours: function(id, hours, minutes){
				projects = this.state.projects;
				projects[id].hoursSaved = hours;
				projects[id].minutesSaved = minutes;

				this.setState({projects: projects});
			},

			deleteEntry: function(id) {
				projects = this.state.projects;
				delete projects[id];

				this.setState({projects: projects});

			},

			daysHoursToString: function(moment) {
				var day = _.find(this.state.timesheets, function(ts){
					return ts.date.isSame(moment);
				});
				if (day !== undefined) {
					var projects = day.projects;
				} else {
					return "0:00"
				}
				var totalMinutes = 0;
				for(var k in projects){
					totalMinutes = totalMinutes + projects[k].hoursSaved*60 + projects[k].minutesSaved;
				};
				var totalHours = parseInt(totalMinutes/60);
				totalMinutes = totalMinutes - totalHours*60;

				return (totalHours.toString() + ":" + ("0" + totalMinutes.toString()).slice(-2));
			},

			changeWeekday: function(e) {
				this.setState({selectedDate: this.state.selectedDate.isoWeekday(parseInt($(e.target).attr('value'))+1)});
			},

			render: function(){
				var self = this;
				var projectList = [];
				var projects = this.state.projects;
				var updateHours = this.updateHours;

				var dayNames = [
				  "M", "T", "W",
				  "T", "F", "S", "S"
				];
				var weekDays = dayNames.map(function(d,i){
					var currentDate = moment(self.state.currentDate);
					var currentWeek = moment(self.state.currentWeek);
					var date = currentWeek.add(i, 'days');
					classes = self.state.selectedDate.isSame(date) ? "day selected" : "day";
					classes = currentDate.isSame(date) ? classes + " today" : classes;
					return (
						<div className={"d-sel"} value={i} onClick={self.changeWeekday}>
							<div className={classes} value={i}>{d}</div>
							<div className="day-hours" value={i}>{self.daysHoursToString(date)}</div>
						</div>
					);
				});

				var currentDay = _.find(this.state.timesheets, function(ts){ return ts.date.isSame(self.state.selectedDate)});
				var projects = currentDay !== undefined ? currentDay.projects : [];

				return (
					<div>
						<div className="top-nav">
							<img className="logo" src="coincraft-coin.svg" />
							<span className="date-title">{this.state.selectedDate.format('ddd, D MMM YYYY')}</span>
							<div className="right-btns">
								<button className="nav-btn cal" style={{position: 'relative', top: '-3px'}}><i className="fa fa-calendar"> </i></button>
								<button className="nav-btn" style={{fontSize: '2.2em'}}><i className="fa fa-plus-circle"> </i></button>
							</div>
						</div>
						<div className="weekday">
							{weekDays}
						</div>
						<ProjectList projects={projects} updateHours={this.updateHours} deleteEntry={this.deleteEntry} />
					</div>
				);

			}
		});



		React.render(<TimeEntryPage />, $('body')[0]);

</script>


<body>

</body>
</html>
