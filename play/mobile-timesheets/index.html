<!DOCTYPE html>
<html>
<head>
<title>Coincraft Timesheets</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=0">
<link rel="stylesheet" type="text/css" href="styles.css">
<link href='https://fonts.googleapis.com/css?family=Open+Sans:400,400italic,600,600italic,700,700italic&subset=latin,greek' rel='stylesheet' type='text/css'>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.13.3/react.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.13.3/JSXTransformer.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
</head>


<script type="text/jsx">

	var ProjectItem = React.createClass({

			propTypes: {
				costCentreName: React.PropTypes.string,
				projectName: React.PropTypes.string,
				phaseName: React.PropTypes.string,
				hoursSaved: React.PropTypes.number,
				minutesSaved: React.PropTypes.number,
				id: React.PropTypes.number,
				updateHours: React.PropTypes.func
			},

			getDefaultProps: function() {
				return {
					costCentreName: '',
					projectName:  '',
					phaseName:  '',
					hoursSaved: 0,
					minutesSaved: 0
				}
			},

			getInitialState: function(){
				return {
					timerSeconds: 0,
					timerStart: Date.now(),
					timeEntered: this.savedTimeToString(),
					noteSaved: '',
					noteEntered: '',
					timerOn: false,
					expanded: false,
					dropDownType: 'generic'
				}
			},

			clickProjSel: function() {
			  this.setState({expanded: !this.state.expanded, dropDownType: 'generic'});
			},

			timerClick: function(e) {
			  this.setState({dropDownType: 'timer'});
			},

			timerStartClick: function(e) {
			  this.setState({timerStart: Date.now(), timerOn: true});
			  this.timer = setInterval(this.timerTick, 1000);
			},

			timerPauseClick: function(e) {
			  this.setState({timerOn: false});
			  clearInterval(this.timer);
			},

			timerTick: function(e) {
				this.setState({timerSeconds: Math.round((Date.now() - this.state.timerStart)/1000)});
			},

			timerCancelClick: function(e) {
			  this.setState({dropDownType: 'generic', timerSeconds: 0});
			},

			timerSaveClick: function(e) {
				hours = parseInt(this.state.timerSeconds/3600);
				minutes = Math.round(this.state.timerSeconds/60) - hours*60;
				totalHours = this.props.hoursSaved + hours;
				totalMinutes = this.props.minutesSaved + minutes;
			  	this.setState({dropDownType: 'generic', timerSeconds: 0, /*hoursSaved: totalHours, minutesSaved: totalMinutes,*/ timeEntered: this.timeToString(totalHours, totalMinutes)});
				this.props.updateHours(this.props.id, totalHours, totalMinutes);
			},

			inputTimeClick: function(e) {
			  this.setState({dropDownType: 'time-input'});
			},

			inputTimeCancelClick: function(e) {
			  this.setState({dropDownType: 'generic', timeEntered: this.savedTimeToString()});
			},

			inputTimeSaveClick: function(e) {
				this.saveEnteredTime();
			  	this.setState({dropDownType: 'generic'});
			},

			inputTimeOnChange: function(e) {
			  value = e.target.value.replace(/[^0-9.:]+/g, '');
				specialChars = value.replace(/[^.:]/g,'');
				specialChars.length > 1 ? value = value.slice(0, -1) : null;
				this.setState({timeEntered: value});
			},

			noteClick: function(e) {
			  this.setState({dropDownType: 'note'});
			},

			noteCancelClick: function(e) {
			  this.setState({dropDownType: 'generic', noteEntered: this.state.noteSaved});
			},

			noteSaveClick: function(e) {
			  this.setState({dropDownType: 'generic', noteSaved: this.state.noteEntered});
			},

			noteOnChange: function(e) {
			  this.setState({noteEntered: e.target.value});
			},

			deleteClick: function(e) {
			  
			},

			savedTimeToString: function() {
			  return this.timeToString(this.props.hoursSaved, this.props.minutesSaved);
			},

			timeToString: function(hours, minutes) {
			  return (hours.toString() + ":" + ("0" + minutes.toString()).slice(-2));
			},

			secondsToString: function(inSeconds) {
				hours = parseInt(inSeconds/3600);
				minutes = parseInt(inSeconds/60) - hours*60;
				seconds = inSeconds - minutes*60 - hours*3600;
			  	return (("0" + hours.toString()).slice(-2) + ":" + ("0" + minutes.toString()).slice(-2) + ":" + ("0" +seconds.toString()).slice(-2));
			},

			timerString: function() {
				seconds = this.state.timerSeconds + this.props.hoursSaved*3600 + this.props.minutesSaved*60;
				return this.secondsToString(seconds);
			},

			saveEnteredTime: function() {
				if (this.state.timeEntered.length > 0) {
				  if (this.state.timeEntered.indexOf(':') > -1) {
				  	split = this.state.timeEntered.split(':');
				  	split[0].length > 0 ? hours = parseInt(split[0]) : hours = 0;
				  	split[1].length > 0 ? minutes = parseInt(split[1]) : minutes = 0;

				  	hours = hours + parseInt(minutes/60);
				  	minutes = minutes - parseInt(minutes/60)*60;

				  } else if (this.state.timeEntered.indexOf('.') > -1) {
				  	minutes = parseFloat(this.state.timeEntered);
				  	minutes >= 1 ? hours = parseInt(this.state.timeEntered) : hours = 0; //parseInt('.5') => NaN

					minutes = Math.round((minutes-hours)*60);

				  } else {
				  	hours = 0;
				  	minutes = parseInt(this.state.timeEntered);

				  	hours = hours + parseInt(minutes/60);
				  	minutes = minutes - parseInt(minutes/60)*60;
				  }
				} else {
					hours = 0;
					minutes = 0;
				}
				this.setState({/*hoursSaved: hours, minutesSaved: minutes,*/ timeEntered: this.timeToString(hours,minutes)});
				this.props.updateHours(this.props.id, hours, minutes);
			},


			cancelClick: function(e) {
			  this.setState({dropDownType: 'generic'});
			},

			render: function(){

				var dropDown;

				switch(this.state.dropDownType) {

					case "timer":
						dropDown = <div className="project-dropdown two-btn">
										<div className="project-timer">
											{this.timerString()}
										</div>
										<div className="project-options">
											<div className="pr-opt" onClick={this.timerSaveClick}>
												<span className="pr-opt-icon notes">
													<i className="fa fa-download"> </i>
												</span>
												<span className="pr-opt-label">
													Save
												</span>
											</div>
											{this.state.timerOn ?
												<div className="pr-opt" onClick={this.timerPauseClick}>
													<span className="pr-opt-icon timer">
														<i className="fa fa-pause"> </i>
													</span>
													<span className="pr-opt-label">
														Pause
													</span>
												</div>
											: <div className="pr-opt" onClick={this.timerStartClick}>
													<span className="pr-opt-icon timer">
														<i className="fa fa-play"> </i>
													</span>
													<span className="pr-opt-label">
														Start
													</span>
												</div>
											}
											<div className="pr-opt" onClick={this.timerCancelClick}>
												<span className="pr-opt-icon delete">
													<i className="fa fa-times"> </i>
												</span>
												<span className="pr-opt-label">
													Cancel
												</span>
											</div>
										</div>
									</div>;
						break;

					case "time-input":
						dropDown = <div className="project-dropdown two-btn">
									<div className="project-input">
										<input type="text" maxLength={5} value={this.state.timeEntered} onChange={this.inputTimeOnChange}/>
									</div>
									<div className="project-options">
										<div className="pr-opt" onClick={this.inputTimeSaveClick}>
											<span className="pr-opt-icon notes">
												<i className="fa fa-download"> </i>
											</span>
											<span className="pr-opt-label">
												Save
											</span>
										</div>
										<div className="pr-opt" onClick={this.inputTimeCancelClick}>
											<span className="pr-opt-icon delete">
												<i className="fa fa-times"> </i>
											</span>
											<span className="pr-opt-label">
												Cancel
											</span>
										</div>
									</div>
								</div>;
						break;

					case "note":
						dropDown = <div className="project-dropdown two-btn">
									<div className="project-note">
										<textarea rows="3" placeholder="Text goes here..." onChange={this.noteOnChange}>{this.state.noteEntered}</textarea>
									</div>
									<div className="project-options">
										<div className="pr-opt" onClick={this.noteSaveClick}>
											<span className="pr-opt-icon notes">
												<i className="fa fa-download"> </i>
											</span>
											<span className="pr-opt-label">
												Save
											</span>
										</div>
										<div className="pr-opt" onClick={this.noteCancelClick}>
											<span className="pr-opt-icon delete">
												<i className="fa fa-times"> </i>
											</span>
											<span className="pr-opt-label">
												Cancel
											</span>
										</div>
									</div>
								</div>;
						break;

					default:
						dropDown = <div className="project-dropdown">
									<div className="project-options">
										<div className="pr-opt" onClick={this.timerClick}>
											<span className="pr-opt-icon timer">
												<i className="fa fa-play"> </i>
											</span>
											<span className="pr-opt-label">
												Start Timer
											</span>
										</div>
										<div className="pr-opt" onClick={this.inputTimeClick}>
											<span className="pr-opt-icon input">
												<i className="fa fa-clock-o"> </i>
											</span>
											<span className="pr-opt-label">
												Enter Time
											</span>
										</div>
										<div className="pr-opt" onClick={this.noteClick}>
											<span className="pr-opt-icon notes">
												<i className="fa fa-sticky-note"> </i>
											</span>
											<span className="pr-opt-label">
												Add Note
											</span>
										</div>
										<div className="pr-opt" onClick={this.deleteClick}>
											<span className="pr-opt-icon delete">
												<i className="fa fa-times"> </i>
											</span>
											<span className="pr-opt-label">
												Delete Entry
											</span>
										</div>
									</div>
								</div>;
				}


				return (
					
						<div className="project">
							<div className="project-sel" onClick={this.clickProjSel}>
								<div className="project-text">
									<span className="cc-name">{this.props.costCentreName}</span>
									<span className="pr-name">{this.props.projectName}</span>
									<span className="ph-name">{this.props.phaseName}</span>
								</div>
								<div className="project-time">
									{this.savedTimeToString()}
								</div>
							</div>
							{this.state.expanded ? dropDown : null}
						</div>

				);
			}
		});

		var ProjectList = React.createClass({

			getInitialState: function(){
				return {
					projects: {
						1: {costCentreName: "Projects", projectName: "Walsh St", phaseName: "Concept Design", hoursSaved: 3, minutesSaved: 40},
						2: {costCentreName: "Projects", projectName: "Sydeny Opera House", phaseName: "Documentation", hoursSaved: 2, minutesSaved: 20},
						3: {costCentreName: "Marketing", projectName: "Photography", phaseName: "", hoursSaved: 0, minutesSaved: 30},
						4: {costCentreName: "Admin", projectName: "Staff Meetings", phaseName: " ", hoursSaved: 1, minutesSaved: 30},
						5: {costCentreName: "Admin", projectName: "General Admin", phaseName: " ", hoursSaved: 0, minutesSaved: 0},
						6: {costCentreName: "Projects", projectName: "Falling Water", phaseName: "Design Development", hoursSaved: 0, minutesSaved: 0},
						7: {costCentreName: "Projects", projectName: "Villa Savoye", phaseName: "Documentation", hoursSaved: 0, minutesSaved: 0},
						8: {costCentreName: "Marketing", projectName: "Social Media", phaseName: "", hoursSaved: 0, minutesSaved: 0}
					}
				}
			},

			updateHours: function(id, hours, minutes){
				projects = this.state.projects;
				projects[id].hoursSaved = hours;
				projects[id].minutesSaved = minutes;

				this.setState({projects: projects});
			},

			render: function(){

				var projectList = [];
				var projects = this.state.projects;
				var updateHours = this.updateHours;

				//object mapping in javascript sucks balls
				Object.keys(projects).map(function(id, index) {
					var project = projects[id];
					projectList.push(
							<ProjectItem 
				        		key={id} 
				        		id={id}
				        		costCentreName={project.costCentreName} 
				        		projectName={project.projectName} 
				        		phaseName={project.phaseName} 
				        		hoursSaved={project.hoursSaved}
				        		minutesSaved={project.minutesSaved}
				        		updateHours={updateHours}
				        	/>
						);
				});

				return (
						<div className="projects-list">
							{projectList}
						</div>
				);

			}
		});

		React.render(<ProjectList />, $('.projects-list')[0]);

</script>


<body>
	<div class="top-nav">
		<img class="logo" src="coincraft-coin.svg" />
		<span class="date-title">Monday, 28 Mar</span>
		<div class="right-btns">
			<button class="nav-btn cal" style="position: relative;top: -3px;"><i class="fa fa-calendar"> </i></button>
			<button class="nav-btn" style="font-size: 2.2em"><i class="fa fa-plus-circle"> </i></button>
		</div>
	</div>
	<div class="weekday">
		<div class="d-sel"><div class="day">M</div></div>
		<div class="d-sel"><div class="day">T</div></div>
		<div class="d-sel"><div class="day selected">W</div></div>
		<div class="d-sel"><div class="day today">T</div></div>
		<div class="d-sel"><div class="day">F</div></div>
		<div class="d-sel"><div class="day">S</div></div>
		<div class="d-sel"><div class="day">S</div></div>
	</div>
	<div class="projects-list">
	</div>
</body>
</html>